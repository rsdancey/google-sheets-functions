# Google Apps Script Permission Setup Guide

## üîê **Permission Requirements**

Your Google Apps Script needs several permissions to access Google Sheets and receive external data:

### **Required Scopes**
- `https://www.googleapis.com/auth/spreadsheets` - Read and write Google Sheets
- `https://www.googleapis.com/auth/script.external_request` - Receive external HTTP requests
- `https://www.googleapis.com/auth/script.scriptapp` - Manage script properties

## üöÄ **Step-by-Step Setup**

### **Step 1: Initial Permission Setup**

1. **Open your Google Apps Script project**: https://script.google.com/d/1Xzoi9iquQrT_nJJxb_7y100v5LPzI4w4u2ICLpPoBO7-PzYGsJiMuZHh/edit

2. **Run the permission setup function**:
   ```javascript
   setupPermissions()
   ```
   - Click the "Run" button
   - Google will ask for permissions - **click "Allow"**
   - This will test basic spreadsheet access

3. **Check current permissions**:
   ```javascript
   checkPermissions()
   ```
   - This will show what access you currently have

### **Step 2: Configure API Key**

1. **Generate API key for security**:
   ```javascript
   setupQuickBooksIntegration()
   ```
   - This creates a secure API key for your Rust service
   - **Copy the generated API key** - you'll need it for the Rust configuration

### **Step 3: Deploy as Web App**

1. **Click "Deploy" ‚Üí "New Deployment"**
2. **Choose "Web app" as the type**
3. **Set the following options**:
   - **Execute as**: "Me" (your Google account)
   - **Who has access**: "Anyone" (this allows your Rust service to send data)
4. **Click "Deploy"**
5. **Copy the Web App URL** - you'll need this for the Rust configuration

### **Step 4: Test the Setup**

1. **Test the Web App endpoint**:
   ```javascript
   testWebAppEndpoint()
   ```
   - This simulates what your Rust service will do
   - Should show success message if everything is working

## üîß **Troubleshooting Common Issues**

### **Issue 1: "Access Denied" Error**
- **Cause**: Google Apps Script doesn't have permission to access your spreadsheet
- **Solution**: 
  1. Make sure you're the owner of the spreadsheet
  2. Run `setupPermissions()` and authorize all requested permissions
  3. Check that the spreadsheet ID in your configuration matches your actual spreadsheet

### **Issue 2: "Sheet not found" Error**
- **Cause**: The specified sheet tab doesn't exist
- **Solution**:
  1. Check your Google Sheets document for the correct sheet tab name
  2. Update your Rust configuration with the correct `sheet_name`
  3. Or leave `sheet_name` empty to use the default sheet

### **Issue 3: "Invalid API Key" Error**
- **Cause**: API key mismatch between Google Apps Script and Rust service
- **Solution**:
  1. Run `setupQuickBooksIntegration()` to generate a new API key
  2. Update your Rust configuration with the new API key
  3. Make sure there are no extra spaces or characters

### **Issue 4: "Web App Not Found" (404 Error)**
- **Cause**: Web App URL is incorrect or not deployed
- **Solution**:
  1. Make sure you deployed the script as a Web App
  2. Copy the correct Web App URL from the deployment dialog
  3. Update your Rust configuration with the correct URL

## üìã **Required Configuration Values**

After completing the setup, you'll need these values for your Rust service:

### **From Google Apps Script:**
- **API Key**: Generated by `setupQuickBooksIntegration()`
- **Web App URL**: From the deployment dialog
- **Spreadsheet ID**: From your Google Sheets URL

### **From Google Sheets:**
- **Sheet name**: The name of the tab where you want data (e.g., "Sheet1")
- **Cell address**: Where to put the data (e.g., "A1")

## üîÑ **Update Your Rust Configuration**

Update your `config/config.toml` file with the real values:

```toml
[google_sheets]
# Replace with your actual Web App URL
webapp_url = "https://script.google.com/macros/s/YOUR_SCRIPT_ID/exec"
# Replace with your generated API key
api_key = "YOUR_GENERATED_API_KEY"
# Replace with your actual spreadsheet ID
spreadsheet_id = "YOUR_SPREADSHEET_ID"
# Replace with your actual sheet name
sheet_name = "Sheet1"
# Cell where you want the QuickBooks data
cell_address = "A1"
```

## ‚úÖ **Verification Steps**

1. **Run all setup functions** without errors
2. **Deploy as Web App** successfully
3. **Test the endpoint** with `testWebAppEndpoint()`
4. **Check your spreadsheet** - should see test data in the specified cell
5. **Test with Rust service** using `--test-connection` flag

## üõ°Ô∏è **Security Notes**

- **API Key**: Keep your API key secure - don't share it publicly
- **Web App Access**: Set to "Anyone" to allow external access, but use API key for authentication
- **Spreadsheet Access**: Only you (the owner) can modify the script and spreadsheet
- **Audit Trail**: All updates are logged in the Google Apps Script console

## üîç **Testing Commands**

### **In Google Apps Script:**
```javascript
// Check permissions
checkPermissions()

// Set up initial permissions
setupPermissions()

// Generate API key
setupQuickBooksIntegration()

// Test the Web App endpoint
testWebAppEndpoint()
```

### **In Rust Service:**
```bash
# Test connections
./target/debug/qb_sync --test-connection --verbose

# Show current configuration
./target/debug/qb_sync --show-config

# Test with real Web App (skip QuickBooks)
./target/debug/qb_sync --test-connection --verbose
```

Once you complete these steps, your Google Apps Script will have all the necessary permissions to receive data from your Rust service and update your Google Sheets document automatically.
